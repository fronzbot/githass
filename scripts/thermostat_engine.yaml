thermostat_engine:
  sequence:
    - condition: state
      entity_id: input_boolean.thermostat_enable
      state: 'on'

    - service: script.thermostat_set
      data_template:
        mode: >
          {%- macro hot_outside() -%}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                'ac_home'
              {% else %}
                'ac_sleep'
            {% else %}
              'ac_away'
            {% endif %}
          {%- endmacro -%}
          {%- macro cold_outside() -%}
            {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                'heat_home'
              {% else %}
                'heat_sleep'
              {% endif %}
            {% else %}
              'heat_away'
            {% endif %}
          {%- endmacro -%}
          {%- macro nice_outside() -%}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') and (states.sensor.bedroom_temperature.state > states.sensor.pws_temp_f.state)%}
              {% if ((states.sensor.living_room_humidity.state | int) > 58) and (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                'ac_home'
              {% else %}
                'off'
              {% endif %}
            {% else %}
              'off'
            {% endif %}
          {%- endmacro -%}