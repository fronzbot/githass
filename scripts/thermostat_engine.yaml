thermostat_engine:
  sequence:
    - condition: state
      entity_id: input_boolean.thermostat_enable
      state: 'on'

    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room
        temperature: >
          {% if states.sensor.pws_feelslike_f | int > 77 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                75
              {% else %}
                78
              {% endif %}
            {% else %}
              82
            {% endif %}
          {% elif states.sensor.pws_feelslike_f | int < 55 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                67
              {% else %}
                63
              {% endif %}
            {% else %}
              57
            {% endif %}
          {% else %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') and (states.sensor.bedroom_temperature.state > states.sensor.pws_temp_f.state)%}
              {% if ((states.sensor.living_room_humidity.state | int) > 58) and (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                75
              {% endif %}
            {% endif %}
          {% endif %}
        operation_mode: >
          {% if states.sensor.pws_feelslike_f | int > 77 %}
            'cool'
          {% elif states.sensor.pws_feelslike_f | int < 55 %}
            'heat'
          {% elif (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') and (states.sensor.bedroom_temperature.state > states.sensor.pws_temp_f.state)%}
              {% if ((states.sensor.living_room_humidity.state | int) > 58) and (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                'cool'
              {% else %}
                'off'
              {% endif %}
          {% else %}
            'off'
          {% endif %}

    - service: homeassistant.turn_off
      entity_id: input_boolean.on_the_way_home