thermostat_engine:
  sequence:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.thermostat_enable
          state: 'on'
    # Need to set mode first, we do not use the settings, they are just temporary
    # If we do not do this, the script will still work but it throws an error in the log
    # so this is a kludgy way around it
    - service: climate.set_operation_mode
      data:
        entity_id: climate.living_room
        operation_mode: auto
    
    # Now determine temperature set points
    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room 
        target_temp_high: >
          {% if (states.sensor.pws_feelslike_f.state | int) > 77 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                {{ 75 | int }}
              {% else %}
                {{ 78 | int }}
              {% endif %}
            {% else %}
              {{ 82 | int }}
            {% endif %}
          {% else %}
            {{ 80 | int }}
          {% endif %}
        target_temp_low: >
          {% if (states.sensor.pws_feelslike_f.state | int) < 55 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                {{ 67 | int }}
              {% else %}
                {{ 62 | int }}
              {% endif %}
            {% else %}
              {{ 57 | int }}
            {% endif %}
          {% else %}
            {{ 55 | int }}
          {% endif %}
    
    # Determine operating mode (auto or off)
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.living_room
        operation_mode: >
          {% if (states.sensor.pws_feelslike_f.state | int) > 77 %}
            auto
          {% elif (states.sensor.pws_feelslike_f.state | int) < 55 %}
            auto
          {% elif (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') %}
            {% if (states.sensor.bedroom_temperature.state | int > states.sensor.pws_temp_f.state | int) and (states.sensor.pws_temp_f.state | int > 72) %}
              {% if ((states.sensor.living_room_humidity.state | int) > 58) and (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                auto
              {% else %}
                off
              {% endif %}
            {% else %}
              off
            {% endif %}
          {% else %}
            off
          {% endif %}
    - service: homeassistant.turn_off
      entity_id: input_boolean.on_the_way_home