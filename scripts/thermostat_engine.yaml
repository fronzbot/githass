#######################################
# This script allows for thermostat
# changes based on outside temperature 
# as well as time and presence
#
# Thresholds:
# T > 77 --> turn on AC
# T < 55 --> turn on heat
# If outside is warmer than 74
#    And inside humidity is > 59% or warmer than outside by at least 2 deg
#       --> turn on AC (set point is two degrees less than current internal temp)
#
# Set points:
# AC HOME:  75
# AC AWAY:  82
# AC SLEEP: 78
#
# HEAT HOME:  67
# HEAT AWAY:  57
# HEAT SLEEP: 62
####################################

thermostat_engine:
  sequence:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.thermostat_enable
          state: 'on'
    # Need to set mode first, we do not use the settings, they are just temporary
    # If we do not do this, the script will still work but it throws an error in the log
    # so this is a kludgy way around it
    - service: climate.set_operation_mode
      data:
        entity_id: climate.living_room
        operation_mode: auto
    
    # Now determine temperature set points
    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room 
        target_temp_high: >
          {% if (states.sensor.pws_feelslike_f.state | float) > 77.0 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                {% if (states.sensor.living_room_humidity.state | int > 55) %}
                  {{ 74 | int }}
                {% else %}
                  {{ 75 | int }}
                {% endif %}
              {% else %}
                {% if (states.sensor.bedroom_temperature.state | int > 78) %}
                  {{ (states.climate.living_room.attributes.current_temperature | int) - 1 }}
                {% else %}
                  {{ 78 | int }}
                {% endif %}
              {% endif %}
            {% else %}
              {{ 82 | int }}
            {% endif %}
          {% elif (states.sensor.pws_feelslike_f.state | float > 74.0) %}
            {% if ((states.climate.living_room.attributes.current_temperature | float) - (states.sensor.pws_feelslike_f.state | float)) >= 1.0 %}
              {{ (states.climate.living_room.attributes.current_temperature | int) - 2 }}
            {% else %}
              {{ 80 | int }}
            {% endif %}
          {% else %}
            {{ 80 | int }}
          {% endif %}
        target_temp_low: >
          {% if (states.sensor.pws_feelslike_f.state | float) < 55.0 %}
            {% if (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') or (states.input_boolean.on_the_way_home.state == 'on') %}
              {% if (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
                {{ 67 | int }}
              {% else %}
                {{ 62 | int }}
              {% endif %}
            {% else %}
              {{ 57 | int }}
            {% endif %}
          {% else %}
            {{ 55 | int }}
          {% endif %}
    
    # Determine operating mode (auto or off)
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.living_room
        operation_mode: >
          {% if (states.sensor.pws_feelslike_f.state | float) > 77.0 %}
            auto
          {% elif (states.sensor.pws_feelslike_f.state | float) < 55.0 %}
            auto
          {% elif (states.sensor.occupancy.state == 'home') or (states.input_boolean.guest_mode.state == 'on') %}
            {% if (states.sensor.pws_feelslike_f.state | float > 74) and (now().strftime("%H") | int > 5) and (now().strftime("%H") | int < 20) %}
              {% if ((states.climate.living_room.attributes.current_temperature | float) - (states.sensor.pws_feelslike_f.state | float)) >= 1.0 or ((states.sensor.living_room_humidity.state | int) > 59)%}
                auto
              {% else %}
                off
              {% endif %}
            {% else %}
              off
            {% endif %}
          {% else %}
            off
          {% endif %}
    - service: homeassistant.turn_off
      entity_id: input_boolean.on_the_way_home
